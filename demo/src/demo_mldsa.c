/**
  * @file  demo_mlkem.c
  * @brief Validation Test for MLKEM Code
  *
  * @section License
  *
  * Secure Element for QUBIP Project
  *
  * This Secure Element repository for QUBIP Project is subject to the
  * BSD 3-Clause License below.
  *
  * Copyright (c) 2024,
  *         Eros Camacho-Ruiz
  *         Pablo Navarro-Torrero
  *         Pau Ortega-Castro
  *         Apurba Karmakar
  *         Macarena C. Martínez-Rodríguez
  *         Piedad Brox
  *
  * All rights reserved.
  *
  * This Secure Element was developed by Instituto de Microelectrónica de
  * Sevilla - IMSE (CSIC/US) as part of the QUBIP Project, co-funded by the
  * European Union under the Horizon Europe framework programme
  * [grant agreement no. 101119746].
  *
  * -----------------------------------------------------------------------
  *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions are met:
  *
  * 1. Redistributions of source code must retain the above copyright notice, this
  *    list of conditions and the following disclaimer.
  *
  * 2. Redistributions in binary form must reproduce the above copyright notice,
  *    this list of conditions and the following disclaimer in the documentation
  *    and/or other materials provided with the distribution.
  *
  * 3. Neither the name of the copyright holder nor the names of its
  *    contributors may be used to endorse or promote products derived from
  *    this software without specific prior written permission.
  *
  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
  * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  *
  *
  *
  *
  * @author Eros Camacho-Ruiz (camacho@imse-cnm.csic.es)
  * @version 1.0
  **/

#include "demo.h"

void demo_mldsa_hw(unsigned int mode, unsigned int verb, INTF interface) 
{
    unsigned char msg_char[65] = "0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF";
    unsigned char msg[32];
    char2hex(msg_char, msg);

    // maximum ctx (256)
    unsigned char ctx_char[65] = "0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF";
    unsigned char ctx[32];
    char2hex(ctx_char, ctx);

    unsigned int msg_len = sizeof(msg);
    unsigned int ctx_len = sizeof(ctx);

    unsigned char d_char[65] = "D71361C000F9A7BC99DFB425BCB6BB27C32C36AB444FF3708B2D93B4E66D5B5B"; // NIST TEST
    unsigned char d[32];
    char2hex(d_char, d);
    
#ifdef AXI
    unsigned int clk_index = 0;
    float clk_frequency;
    float set_clk_frequency = FREQ_TYPICAL;
    Set_Clk_Freq(clk_index, &clk_frequency, &set_clk_frequency, (int)verb);
#endif

    bool is_external    = false;
    uint8_t key_id_1    = 0;
    uint8_t key_id_2    = 0;
    uint8_t key_id_3    = 0;

    if (mode == 44) {
        // ---- MLDSA-44 ---- //
        if (!is_external)
	    {
	    	secmem_store_key(ID_MLDSA, &key_id_1, is_external, NULL, 0, interface);
            // secmem_store_key(ID_MLDSA, &key_id_1, true, d, 32, interface);      // Test specific Key
	    }

        unsigned char *pk_44;
		unsigned char *sk_44;
        unsigned char *sig_44;

		pk_44   = (unsigned char*) malloc(1312); memset(pk_44, 0, 1312);
		sk_44   = (unsigned char*) malloc(2560); memset(sk_44, 0, 2560);
        sig_44  = (unsigned char*) malloc(2420); memset(sig_44, 0, 2420);
        unsigned int sig_len;

		mldsa44_genkeys_hw(d, pk_44, sk_44, is_external, &key_id_1, interface);

        if (verb >= 3) {printf("\n pub_len: %d (bytes)", 1312); fflush(stdout);}
        if (verb >= 3) {printf("\n pri_len: %d (bytes)", 2560); fflush(stdout);}

        if (verb >= 3) { printf("\n public key: ");     show_array(pk_44, 1312, 32); }
        if (verb >= 3) { printf("\n private key: ");    show_array(sk_44, 2560, 32); }

        if (verb >= 3) { printf("\n msg: ");            show_array(msg, msg_len, 32); }
        if (verb >= 3) { printf("\n ctx: ");            show_array(ctx, ctx_len, 32); }

        if (verb >= 3) {printf("\n msg_len: %d (bytes)", msg_len); fflush(stdout);}
        if (verb >= 3) {printf("\n ctx_len: %d (bytes)", ctx_len); fflush(stdout);}
        
        mldsa44_sign_hw(msg, msg_len, sk_44, sig_44, &sig_len, ctx, ctx_len, is_external, &key_id_1, interface);

        // TestId: 6 -> https://raw.githubusercontent.com/usnistgov/ACVP-Server/refs/heads/master/gen-val/json-files/ML-DSA-sigVer-FIPS204/internalProjection.json
        /*
        const char pk_44_char[2625] = "79F984109990D7ED99515D7D0AC2F6447A5D928F353DFD80617D3F94A9076A318A55BD960CFDAB6340343BE6F2E82B0EA208B35FB7C7EE18D4BC29A5D9799728392B0B57388497A15EB2C72DB80695E716F2275B3E97586FB5E47BBC3A93E2B9C1D67BF73DD1846F5DBA968C90EC36DE55AB926BBBE7383EEA70BBC93499B4E09070BB1C538716F60F540A9EF59B119D872B3BC000FFD981B3DF40FBD1BDF7711634ADFDD52E4BD054AB565F735674F37C9543FCFF9AB9B02294E7581D96E5E01C1087392DE72E3314D156576A6D7E8997E77E297824D784FEEBDEAAC88D901627C25CC09B340368D875C1D82E6BD72D475D6D5768B3DDF30CF776A40FD0C851C441A9DD55E71504F61D0E508231C4606CB0F360F7495FC7B8165F4A90AC6D452342F05BEB7DBE0A0ECAE9970A4773DF1EE6646F9D975034866CB5B3F77490F1F0BE7DF8878EBD69E602DA6C892E513F75BABE6148FDF213DFE905D33CF25E6131B93BE1B311C764E37F26E66BE28CAB17D87D1813179B7805CCCADCEF4EC684415730136B6B4F6B654ED44C0405969A1801E48167549DAA12C5A44841CFEF66DFFFF8A62C59706973421396F4810C6A173DCD3C16F65DC110E50FF2B49DB90B93905360936A6258431099CA4C669286A0413C8C4925F51362EDBD0DF82B1B8DFEA8A29BEEC210472C8E466125AE3446F600492C47DE5FC4B63C18DB0403BBEF35B059AAF76275B54F2A46E4535FAD1F75AC4D11C3E907146179F5EA018FD04A860994638BDCB0DA243398217B7661B6EB60E5824724C9A3FB2DBA4E27D0AC393CA3315B7C7154F1F1B703A3F76B345D85F251637CFFDEE281BA77F7E7D9181F4308FB829AF3DE5EDE05A34F9C90315D45FC93D68A5BF5940A7C8578DE13EB7988B99AD0A1EFBEEC79AF6D22932FB0EE7C679EA5D80164E4C10C722E42F09FE680CB221E0B7A4F5B43F260569A6DBE44340D69396166F15593BE97F083FFD36FC08AF0AED398222915FAE98CDFF1414325AC4B748D09D7B1969D661FE20029EAF5C02F6E37C606F83D65E8AA2583719F3C6C49F1A066CE67555C86EDC62F05631CBED22E824E7B883EECCBCED45F874CBD3507F90F1034DA73487BB6557FF8CB2480D2AA51F1A324E77BCBD1F2855B997B49C408B1E87A9BD227879602D283813AD57D88872D35375224D069E1FC3577B646C2EFC3BF75521977F915F8A593A3AEFCEF0E65822DC938BDC30584E2C4BDDCEC37C219E68BA9E1A3C032DD53C2AEDA51413FEB360DCFB61DF29973DFAE5193122021034F81B585A68E31E8C7ACF018649767590982C7B37C420A4913315033FAFA5EA90016AA0BDBC4CBA256C75324F7F49918765DA675AEED6479FF63A667B7EFECAE2D26BC9B3259CB120808569862403CCA87F65EFA03C84F0CE5E3DC0BC977F4A85C52802132AF7BE921F9A0FA7A4091C8DFF6AC16C9C610984DA1CF3374FD4B4907F15F07ABDB1F81B4C7EB3EB064D68A665B7216C9C171EAB0354C938AE59A160FEE2E1F9D60C0E8208DD5361CA74A33CF36FBC63E5C700391C5AE60500DA863F1C5BB9AB9D36DB6D7523ACBDF5FD780538CE058AF58A94711F2187512E750BE1C215B53030BADE044010C5A27D8AFFD9978CB46B10F140407AA3B80B7995BF39EFB6FEE46ECE7303CC7F2B6B3563CB46C2DB00752B1A7396D55B3AF8627C19B3CD8F4B24613589DDDCE767EB3F693344F00775AFAE048C307975C7D5C3407F6501318626D857ECA835D5FD4C4B18FCBCBE19F6CFBD7DB620B225B552A163B6FC7499F342090E8E4E2A91440F0C39931FA99F2D52830D9213C7C48DCF07CE587711E8192FEF186254CEE19";
        char2hex(pk_44_char, pk_44);
        const char sk_44_char[5121] = "79F984109990D7ED99515D7D0AC2F6447A5D928F353DFD80617D3F94A9076A3110B7F7CE81DA6CB217D98DD826C46C27FFC448F447F616F6672C59D907FA2F29392D23761DBFB6561A7CC8D3CB2FE39A47C97D0CD35E4FB20B0693389DA033CA26AE50E29A6F8DB020B2F7B5020E3D28626BFC44C45B323DF9FF702020852EC8A0B8040B116E62C884082025C3026613434A23146961004901A0290411028B4811D1324DC3283114391111A585A4920412001209302AC2280124230D01155011920923992C0449885230842311494BC63004C480A1A20DD0986542A22814046222C98D50186562B449191006598629D0080620994050026923146A53462C1347018C244A4B2085D1B610C80840C93071C1348242022C8B96241A123211112E113848131172439664D4B8645BA08D1C0009C89871C1B46149B22523824C8C042D14B82C44C621A12261DC80691C320EA12268C3826960B26502C16909096EDA2284003091D2066D4C98058A3890A216205A4420D4C600220231622011E2322963986D402269C0B0500221641008024C1401CB903004180464A80862344884324688B880108390C2140960A810582249630284D142458A369202B16941326C020961A4906041140A5B188101228E08C90C599081C022401AA6090105804A8060DA9621C0304D04C185583612C2320C8A084810A24991A680C82024E0A60CA4A89191284602344C40064E84921140C888D9C48108B67092C28D893202A4388D1B190D1CC44041088289308E12A009D12471CC262223338A02A06150C800C9464424C6644B162C138105C8802DC4026640A8315C3028E1C46923102883282A92824102472D0005660B269000B32902B084532004C29460231721CA140AD14031E2043099922C08A640530061021884012906CAC688491832DA162523336153066210B700431222E02844A126226190644148900C172DD4323202876912843002184AA1164221022613068A13101114402A0B9530981432902870C3A28164088804337121B420CA2608248584134625430029A29449822851180204C21831432646DA0271E120481A0130E34230001624D3182D61C0084B8221D1C64DD90821512066C2324903280104150424852D8B2824D1C28401C70190905103152E18440489464864A60C140325210724D9A0290A372C022380CA0048212742D210805146904B98095C842C19279252C08459362003826440B20CDA86211443725A32090B39400415F59B2BAD974BF32B9ABFC1F75034DB3AB81539652C05D93C10B5EC8D0566C80DC8FD916C4EA1C648288E076B07E1B6C2A166CD80B1826E67E9EDC20A3AD4A1651012DF17E570DA37175448D3D35C0F3038CEFF26EFEE7EA159ACC3F7B66E796811D6566B4E05D56718CC3DEAA5BA9D8EB8B43B051AA723D75500713C1B7EE3B3F150E65C901965BB79FD27F7CEBE44984F68A6D7E0C83DC183D8378C28D121C6F233B3A8A1C5DEA137662A8AB8959E2498E7138AB40899381766B3E09FCE35F675B25C36AC02A3CDDECF08248CCB66AF18D109A50F7EAE85BBFB618E8D2A57C909DD8B288B0347C53DD4BE2FF2C779F5F361C49C50F2A176973B30CD29D3D8EF83138206305B6BFC35320910EF0C6F4C02365507315F552ADAE56AD1553D921DBC9B6335D3792EED67A2FAD618501B67EBB1FA916B9238911C13897AAD0DDF9A84193BE6926999EC5B830F3B3596A564238D1D74603AF0C802244CE1CEEE526F67EDC1D058669E02FCDD8CC41FF0157039A51070883E278AF34AE75B7265E7EEC0490681C9E2F2476B71B5E113BBA65EAE248D165ABCA8F7D3C1BC3279085BF794B679AF77929B3CEEA89615742E792FD23714D9D6DAB89D5B0FDDE66CF1FEB594FAC53E66ACD6F23C837382824D460A6C28E5FE3BCA028707A2CA5BFA01D046067AA5E880B13824DEF5C504ED05591105B66541150A06DD4448FDE003A4CB0C7717B959D2818F9BA769318E60E0488687C106F0F1096DEBF3A8E7E1B5E401C85C1F9F51667E801ECFA1E460B68E5A12A9AEB21DBFA2450D0DBFE1B1F3D918BF5D9AB61CFCCE228CB2658C173C89DEC980B38B7AC43847111B1527048FCAD0EEC5DD9D61C6252DCA81C00FA7828CB10E5583D9FEDA350C4896690118BBC0A226D1E5413713970B5EE65B3578B6B9D39108DF178761B73916B288B34D65E3280CACBE24C92074467002368A2EF7A56D2AC9F3ABD7C230C87B5999239E84B6E3FC83D8FF8FE44B6384B689475A4BB4B2245F8BF52141650B0A4743EF5D56420B08D76124B6D284449EC2F8127F2CF793ADB5354442C757E6D499AC7479986B993A3C6502C150E19949EFB777C9026AFDBB8E8B1CA6204F8CBE84D86FA73E555E44CC358C1C70980E0F29CFEEB5B83586C69F6F710309A20B0088A3B251999B4DC5ACE7BD6D41A716E6224593E0314DCD802F8B3B78F56C829E9737C71D397B2F17825A9BEC15BFB8B14E3D9E40FEB596C92229046AE082740D0D7E7D2A5F02F21E3F267F43E0245879971DEB3149836126E7EE5B6CBF9EA6801A12187AB974FE945357678AE9AF20F16047FE0B4360D90170EEA2B2A2A59E3A7CAADD7C3EE11CAC1CA8F04D40B2007F08556BC6D5AC627ADC97159C3FD4F270AC5EAC9939CCE53EF22D8DBA4579875D68F2F21FDD0C738327AC1414A515A6F252780B18D7F88CDF38E2D119CC66B9802E48B68CE56D735AE19F115A532793FF2171AEB906A154A2CD5383A9548593022E637A1A158ABF78CC69A40F21891914CE3804D83C42786F44490865152E64644528C9DA537D1A96231B848B69B96472A5DB0F74F21B41FABCAEB3E4A84FD8D50E573B6E17BC50D4CDB824FFFF3105E99DFA28C7215ABFE27CAD351D27F022E72C915A1FA369ED3EAE538861469B57EC037B87EC2AF1AC93D50874D37783720441F1A8C23DF7ABEDF047E5EB4E237B1C50B49265B899343F97647374DE5B29D66064D2B1CEEC4ABE81FB22556E6570114E796132F955E10976BE22896591AA00AB70D9F90E3E8C9E5C53E143EB6089C32C59F25E3F430454603E63E5938B74C4026A316DAF13A85384DFBC34363DF1D1882537F336DF4E66F0AF572858FCD834079D8FC246898CD3A882A9969853969528902D2F2D2F2763696179A190AD206FB406DD82B67116856AE9F4B3D555B24292C9378DF8D6D5FEFD85ACE5A34B02AFA9221D418584A4AF2463EBCBCC272066CABAADFE896AF94A5B0E4E0C36686AE3DB8B0B55D19873F7D4271E5B8727FEB6BB697CE1E3929AF537A2713B62C008E47345979C8382C69FACA5607E6D44BFA01EC6D4018BB310892E22B06C3496DEC88FAF93CDAD5D9B796F0D3A74AA5CFBFF498B9CA5F5E56897AB4A4420FCEA68303CF1DCCB6A1827CF111B94EBBD767E66F06FC17EF23D0044A73A876544DE74EF0315C4FBA5C037713E95563374347DE3187AD3A9F2A651CD31BDD02C4DCCDE0FBC620318147C764B10DF57994645E4637AADE48CCD3236BD7B351CDA2252B30812D8D03F42EC6DA39947AA82662FE87FF4C7CC1486C9D70138C41744A9D1014B16571A5C394E727651E5ED8EEE4BB559F4A5AF208412"; 
        char2hex(sk_44_char, sk_44);
        
        const char msg_char[7931] = "94888F9A3630C7A2AFB806B3B9D5D8B4F348A6A07FD62C795716D354BD5D858198215127110215692ED08245F83C65059C5A9290FCE3E6E5AFA19D4B99F67232FEFFF01EDB740F85D8A28465BCDC1AF5626D4A2F8F838088402D9C2088ED0BB2353F221232C873E78A21147C6C26134CC22639A5A9A872201122E74F5C99A7EC1EF08CD028DC1B9C13F3D702A391AB277CF8BA30DA2AA3C20F4AEF4D6486DB6124B80E174D90457D5614CF4C6A816B01704BD538FBCBA42C08D9606D5972B0E24042840F921B735230B6FC7F57AC9C70B848C015691BA4A8C7A033C0E27533539326F806F2234930613F53A0736BCD3C9A42E38DC5440939487632DC4BD491845670EB24E836B29BD6865A7355EC1EF97D7F9574FA8AC37E4BE13DA4BF1FB6BBB2A88C92654BBB30B6DE1889C3551A861AF1FC0290442DE3025070A3666979EE0F1DC86F7339EA7A8125B8286EC5CFBB84A40E380EC5D97B18FFCB50C53D556E06864F93119E2A292A0BC869C046E3CDA035E0BCD880755EB0DA0E9D6215854A8F786E529370F16561E6B983248A55269D2D654A87E5E774D9E30302048B0FE38EEDF3156C81FB068068A2BFF54E41B4DC122971F81437838EDBD38E7671CD03A5AED2663E3239C69F5E5FBE687550AD717A74D18EB59261543248A6479A64DF270B3545FBB32E51E4B7278A758BB5D6811B29DB51F40EDBF3CE1A6C831D7EC6E9D44A1E4CD1C89A55C6C69C90852F6E9FCCC3C6604DB371298116C44E8417AA54B710A4FA54A345E189290566375C0A9268F19BC7D37EF9794473EF16AA247ECB2CD4ED90C2D690678B99DF472DB69D712D6F7203E3D629A4A167D1E50BD07B6970321CD5CD3802DBF47E9EFC239BE01559FAE7258DEFFE48AABAC8C4B285E6299502E20DCCF66B159400F3E11ED35F692B836AF1FA106B533FE8CB394D97DCE760BCD082050C99C3ECE236F8433E3075F3165B8E6C46E66684E71965BA58F7CBF9361F4F4953808712D738E177EF3B594D85914562D51D800C19D58593AB9B25C4ADE87E977EFB855BBE648AC7F37F5A6CAC10567DBC79E2B4B7CE44D8DB457662FFD5F74AA8065EDC0E01DBB8D237DA5EAE60D922FE2499A533269DDCD7945D9A1C5CFECDDE09CD853254A1551E15DA55AA1C6C38DF93BFFEA3D553758C9130B057FACDAC8D857A1B99B8B5BD233C7A869C296D0744B494EA098C535824673EE811C592999B767F1823B1ED747DC98AF62E77DCCA794175EA9369230C9E9ECC862C3286AD33A8FE79F4E749BA9E27532D98F1F7F1ED6B1B9873C64199EF73006D6C8B9CD0F723E82569CA3694D9E8B0D50313809E0B3912C9037DD11BCE67432A7B23A34EFD56411990032A00341E1544E11001339E7B900FDA9926383C782893CB6AB2EF2D91E504471F1A9C49ED622AB60D94F6FB0F952E13D1E0E25A8938AA9F73EE9749CC527506FC4334AAA3E0BB7B81C17522C707B902FBBC7F07EB008A53C53F2AA9DEAB7783B7BE02C9972ACF50E8CE5A138C6FDF9E9775F444D52CC5FF0CCCD57231A44ADCD50292A7A55177F0005534B1FF97209AB25B4D28874D854965A81A0F1BCFA61D7F5AAAAD0991F9E59D7C915B762AA827DBF042D7C1C93680AF9C399F36146D91B0AADBA7BEFB8BF4330FF1BECD34E59E485123896057C85B0169A895862DF48F3B5E905CC9F078FF79A22E892538E95831BFCD2BA4A8EF4107A59837FA0597629917F6B78C175E167CC7315098CF009AA0A39A1E908DA631151D732707F5C7ABF3C75925D28AFBCCDE5DB84AD9055E7BCD9F2CC1B08A29F23CC84188E33C7434120B56F64ACE39CC654BA9BA7FE3F957A557647B29D9B749BEA3F30B5761178718382DD35C04D2321B569B68D4E89630D398EAFBC48C6C40DEB2FB1D00542201B37DA21514CDF090532908961996FCB9C1F3607A62CB05BA4E42A04C94265B23ECB4FED0A1572434134CC6CA47BA827FFF8F435B770FB5B24E446D390103DC19F34F519B15FC49054FD889187D54FFBB7BA24F713F4F723E5014CCEB5D740C9C65431E4676FD214F0183ABEA4E06C61B30CBAD0D9F415D1295C898374B4A88FAC2D71E436F2F8628B0EFB39D610807E94C1836E66ECE7483878D75FD25D23FB4200CF255EF123366B11CDC14C5E5A00BC6BE098BFFA907B42D0E56A39638448D0478820213CDA755A336907683A292DE310B356A5F442DA30F06229768D79C419260B657C3D117FC2969CF2D4D16BA4FA6BE7A3279D7EDBBD046D32AC9D1BE7363DD8D3EF1389CAB3EAF424DFFFEEAE330EC68274AFF1E209FA890607C55AB6BB6CE2B37F9EB3B0EE6C43298F78D6461A65080743C75418E15872A2D47837071473ADA635F9133B160A59C8C8E34A7CAD6D7E3EDC7F2A590328BC82D9D9CB48251C1CC9F583A388A3E4766E2057319DEB5C7CAFB05C13213D9329E981B72F9C788A2FFA8125C92A1D3E9AFF9067FC3D023E4A096633C255169DFFBEADB0C74ED416C62C9433DC3555E2E382B129BF2D51D79A48F5F3B34EA6B43E5D5B1F0CF0B14C195F954E049C874FFD1982791944EB5ADDAAB1888AFD765B7AA8D05375430C65FBCA7EAA882F825BD180E129AA116D1EB0D0620966BD06980A1D7D86F858D0EE432C8A76639C2B3FB4183591858078E83FD8BC46314F927630E246A35F3674071276BA13099CE77D269358F933377A40B0DCCD6C6FF354FD3F84035B1951C30D1168D90FC129B4FD352C49864CC20A343D5FF52243857FFB867B4CBE9A2C99602995CB3D7BB7A0B5FF10E1DFEEEB787C429D77A2B1ECA2DCA644C761EFB41E26FC2861B54E5CD1B4F2B70EF66216304DED2C72A85395889B5B098A4D7C937D0E0753E62F2955A8B535DB384A77FDE6209234055CB2157AE2479B1AE70207803B0186E44836C271F28934BDCE77D02665F09C550CDE7E84FB9C2CE1AB5821F9F399B01A9E63E6CCE730E3CB4701171F393663190BFB29EB2C25582F03B9B2D6548BCEE587095CD909985026C99ABA43CB20AB5E2E7675B28F3723FB4CE0553767AD660154E23FD494918F71BDB9224020A51F68F11A83BA8D13D7C6EDF17A990A0DEFFBEADAE8EA999C78A220F2C6570E01FCC7896F45479940DC4DDCD9610D43B064841030521D6C98D836621CFB5951A4904F0ECE497E81F02C3CF8558361C2DACF2C5C280BAE50FB85C2EDC737C58DC493603B33E812DCB0AC2BDEB308F26BB5FD99E2792DF504DB82E6D1163F3E1C0AFFF147EF17C074A1A57A2D1089D3E266E91D0543C07DC5EB4F52F45CC4723AC93C5896FB5944C2F2EDA2F6F3D0543E7743A5986A07485386FCA133EAC352549C6DFD74B85B360C71770C9C23F4C29C833DB7BF191EA8C6A100E22165B64A0F89C6EBB66CD76C3F02BEA702CDF964692E16FA24C2EC2B78246A4C148A38CB2889DA95986DE0A37D528A9B3496CD30FD257C6A30EEC3DA1F5F49971044CEB9ADF33DD00EE699E58857D8E89CFB8AC1BB8A90E343E6CE6659D97C224368FB464B1796BF5888CB9E18C0410F452DB39B819D001B9B19D134B29658CA84A2A5D9571E0640870C5ECBA63BFD251B80FCB2A400D4E932525451681DCBB74461CA15E56C8041D0579C5676426DEF7B49527E5DAD3C4EC88B35D75FE6A81362D50E141B786E7E0F5A5FE05F9D747839A44810312E9C4275E58E43DA8F9C2047EBF3EABAA793B35983ACE9EFA23446DF0066EC16E00F56CFB8BBBF2BC7F1AC444F9283D4438890905F0030855C0B2194AA1BDC3BD07FDA6FD83E4338240259C43235FAD3D8E0EAEC92CC86BA6F2EFE0BE3E33E21C5EE8A3A665CC53E65235CD5CAAFB44A071577D83D921A5AAA30CC9D6CA86B80E82463F68001F940C9287EBD1720FB2BCC5AA45F64164629E50A3C6FAD9E56E3D06406B5DB8094BB74EBFE83CC0F54D6906A3BB39C4BF4FEDA3F8724BD6E2CC7AC3ABC7C079B95F80E409B591520696C2EF9CDDA56032E9CE01E516188A2FC003503A4256B83D06E3481B6BAD8D51D2BA10FD7B97E61DB4060280FE7F9DA89C4FB743E224C0A7C06B33C3C21439EB4EFF64B3C1277F7846335F03FE79A839A70B30A499DC51376ED224FB0F2C51140A00F9A6B944B4CDF4501F345C2E79E46642F0132943EC48A61EF875F474C96567BC32785D0F7C971F59E78624F75666481970D892B8D03C7857B636DCD426DCD7432BB395C2FED71A83CCF97F659F5C55D44A1B51A0A9936FC73A5BE6971AEC5267EBC354AB3B9234C1783B4C3F03B3B39CCDF7C07943C207805ED054329993BE1938821852F922CB0A949562B013CE978F8E802AD9058BEA04164DCE069CC957DAEC600E9B42411DF8D0C6052EC61DCD2DD7F1FCF06DAB79471E5B94161B9CD09AC329CDE1FB6F808A7198847FD2085FAB64E9A36D631B04BA410A0AC3CC8E905546D73626C832167B5F600B7265BB51281E61A5ABF21772FA50961312EAE0EB7D0AEA3B23317E0C0A959685D5155450551CF4A3B80B9B3F81FB68A5D53CAC11E43621C6B5116D1DC219B14632986D62F56B50BEFBC4219ED1A04D914E4026BBDCC81E437849BCA6DBEF68D9A96CDFCF8DB7E5FBF788D90279991072B7490D2AF25BB31168FB19DA674746D4C79A37E11204DA5C6A19168FDA863E922424ED22C43074E14DF2D4681350140D17B388B82B3496A56BD25A673C01043C632D2B7C555E8850536316A9AA462EC5805390DEC2A1BF4FA042804D80C745649B7EAE42169460A8914B5AEB8436E8EC1FDB2E82659FBA116F4111B5071A9BAE4E9AE092324EA0AFD5F67E7CB32F90B1F888671C7694FE7B11E190B643369F10C80D1A15E8E17486F7A416641BCBF2FFF755EBA62A63BC69AFC873A7D49853EC5A9948A52F8806E42E918032FDAE448588654E9722F9A911B3499DEEC5A31877D714125F517B6446ED0EA0D47570B34DB6394BED0F2B006CF99A2194CFF3F2CE65F5A2B1FBFBBED3525EC32366A3ABD5DE6CE2B8727E6C79C50D5A0F4FB7A5B0310677204591BA98F1BD6B7CA4C67954A9704B74A324D5DD15E742B594B091BDDB67E9E0F7554529E185DC475B826008C2EEC0E07580171BE66E758BBB9B1ECE04C6FF05CF3C436A51C0F4BB3FBB4B8A72FD50B27E9684DA6CB91C3ABF97EAD6401B03A70DD30613A13E76FA5A84D403A93422A5725FEA076D0CD9D54FE4A9C8BA4F3F14BEF4BF95A2C211689EF2E6468F6C1E685FA4267F30C19BCC69A9D6B3A715EC41CA646FC89C824A98DF1AC909D9427F259750DDA79009782EBD5C18ED5AF18267FCBF880E92B6B83D4CB789A8F05929819631A42A7CE9015373027E55BF964F68C2BA6202C416573C7B5A90925CEB303CB2D883AA5945225FC24D24E9F23497DC49E6942195DB591ADBFE709F48C3A098EB71895773984F57DBF7DD1E30323AEBF9D955FD841CAD3B2FF642A99CFE579F6C541B2D1F91B59EE4183E421789101DA70D9D9F630CED079EA9E8293633701A3AF4A7404FE1F89678B80A71244CE5171F78DD0D18929414956B0F18272E56EE8A628FFCA13096841AB532F8208272ADC110578D22FA7CCAF14970E566124CAAB02BF496FAA7277706FF07945C865D0650";
        unsigned char msg[3965];
        char2hex(msg_char, msg);
        const char ctx_char[361] = "F7104C4229A429B641DFA3E7BC912D04007D23181E1D1A6977116B6AA91713460800F8B0ACC3552F90E90FC6996C5F87D154F79889B3E9EFC1F9067ED3BA9F50A53C531C19FF59F816ACCC080CDC627D8F3F244868B9835C1C11B006BC6CDB5CF11CA2FBEAEFC6F69D60510C0F060171FFC2EAAF16906D48383E0BE0F5F75868B9DB0E0D4D61407AEE3BD9D501BC9A28F1A6FD15D49538FF2AF05D2A6AB531763553C9AA2EF217FCD7BF444F9097389569759527";
        unsigned char ctx[180];
        char2hex(ctx_char, ctx);

        const char sig_char[4841] = "B8CB5FE5A9662B215C95D5BA2B0328680F7576A148FF625E23CC5D203E97C62469BDC078CB6438117C1E6669B88A9C2C567894394FC06BD2E4CD754FE9A0C7AA506C004A290306D269059176635E13EAD71D0B50A99F543AEB8AA10449BC3087CAB7420D92020E7693160454229449E0913A3D84DC884BCEBECF6DD93896DA67D036CAB5C57E4671EFA3E21217F45CB4F91299E14F260E9F2260991D286994E6FE96B5B92C6B289B51C1B7F8197778B26DB4208AFEBD2B61ABA5DF09B740D7ACB49B6EE0B488AAF2AC9F2064A924D1ADD6361E19317703CA73024B1521B0247DBFE05199DCA559B3D1037A13015237E2CD5633C27B45140F503FC142E9C16620217CA18B9DD1A2D2ED1C353286426E63DC2AF5E7453299A67AF6E21D87D201CF6069F7196481D6E6FA8424FC5C2D0EB9B203A635472016ADF97810DD4F9CBA8A4B45A5EC4E550643A8349CDE7700E401B62D2B4DF65E08741BB1B79003A850D5E1475B2985DDD770AF073614F510C8C59EE5A8FD785E61BD9AE0299E2A376F2D8727AB02101B6A62195D526E1170643E06D682AFBAC1AD410968FF35E60F5962F07783192498BC7563B9F2F3658816C7901F76F34A76EF8CBD4F05F14181240AFE93BE82EC8E2067EA227AC297FE1BF8A8D456E8EE7766F1F806E55AEB16FA1FB17BB54C382E121FFE67090F40AD5B229AC088A044304833D9E2B05F7DEE98C2B084E2FE066E24963DC66CDD3AB2E58ECDC0718B14D6AF3A58CC7D911B71FA941B03F1DA25EE03D370D9CD440EE31640BCF355DE5C1C44ED382DB6AFD9A1771D355760DD981D939BF045DFD1F08B7850808A0F5B5DABBAC64C927F9C034FA4F66EC183351586E5F7A19F827F0FAD68BBB7C160AF3FBBC59ECC4DF7C9ABDC629051ACC4CAE7E23EAB6BA006D48170AAB6C38FC6E77FA85B30A90034DEB46756C006D5317A044E647BDEA1D017E69304EB3B44344C73893DE13C32E0A272716F38E899D353138BDAE0C5EA63E499C79CB9AF228BEBCC813BA99FBDF0C8F28C238AE5F81E88376F061DC8EF0618BE3A75785921C17FF7AB6EE674FAC5CDF03B69B69878582062D539A41B4B79597CEFF7C7BC8C07A50BCB51577AE64272E5A01EBBA5DC85B2C0C8D736E9EF4F81996CAAE3F12F431044194CE388A510C480D6436244A020D3ECB8F1DB9DA2823DFD510F8F1C3AFEE9A696010E7AC50E794B9E6858657EA7ADB70453DBA7EEF8D5CFD157DC916ABC5EEEACE1CC0EDD4114B4D002904ADA1AC0FFD5C15B5BC07D4F4E33A35DCBBA76573CDB18E288B037A9793D22FBF6F784E87101693581BC905BE02F86AFA6FE9C191BFD52C21122DC17ABA542DA8DD74DF521EE1C0994D50D494B2573BA3811A9CBB8297E2C7CB04914F3EB43BEEDF78A947EC34B96A5EB7CC4DCE75C5B66ED6544699C117D2CC151C3D1DE4D144A63150B6F40DB8B3073802D089938DFE641101D75BF29477F81FDAFE39A7DEDF7B8958CC89C64C03F4E2F370BAFFDBCC12F6900189D6E8C783231E36DCA783C4FE24FB73612A705A1744699EEBC5D15CD49427706BAB668AB933930E280E92A94B70E0C2F874288C140AEE9AFDF91781ECCF6A523DC81612F05BD3129548CD2C723D724AAEADB3768BC5D456E7D65C9FD1CDDD314CDF117FDE6A713DDF3754C66B6ECDA3D24175B2ECC1D793A8745AB25FC8299FA07F256CCCFD5529205568A448181B28BAFAA0369B84FBBE02153615D6C416875C65D3B230651EFADCEA465076C8ECB56A684AB93F7AA71CA6FD6AF595F126D51648CEA184F2220442E16DFAFEA25DDA77BCD2649E5804003E4AE405D186D925FC4B759B8221FC79DF55B4333D63D44D473AF570F42E6F9C8804F7414ACBA273F1F8E72582A88DA767038C3FC345EDBB7A885C46B313C42A30684B04EB6D00DA7DFA2E4CA882FF6B161C485D86E8451DDCE71B15D87FFA504CE3CFC003555E6B15CC4E0667389E524C24522487526DD37C882A4ABCCAD92EE728A742F08CA3A740BBC9BEF476443482483DDB3A46C1B4C030C4BFC08BDE3E835212AB69811267B25840302F4E7B4B7A6A3322A85D93058C32440B25F5FA2660889C20049D558C49910C8575B5820FA70C34D2FC94ABDD14D987DB0EAA377712648B5D976685A4E43FD4622CD3A3AE64C4AEBF3A3C4B29BE6555FE5E39E7F86998073F3714F260089864120BFD8A5A838540432E663BD2F427627BE8504B9DE113D79ECE70F08A4FB25AD3876AB352CCB71F15DEF83F18E33F6B9FC64B9D599E1B6FF0CF7E3C5D9F2ACDC45F10E45EEC9C1341FB952582A58735CC1606A6411CF228F2D003C0952D98068C0BEECCB16C595B37037A50F60A196E9BF8338581043FA15E94F06EA4B1D0B75261F5E87202F59408B1B1E2152459904CDDC06D16C85E1AC48B3A6C8C533665E8CE6B384ECA2454BA7A9D2EE5F28A84D23ED34C73BAACA66D8ABB8348444BA3E6B4F69B7FA68A6BD52871F7DDA19C61FE5E52CF5F6A99266550489A0D366BCEB8BEACAC019ABC6DAE7B45CCFD3EB31782AED29EC8E8CFBA79F89B038AD1BD83BB1F3829C5182AB71AE8CDA16090C50B8EA5DA8B8A09441CAEA026BF5E010236C5291304159C87F0F97C135449F1643B84272A2D6E7D89D1BF5ECBEBAFEAAF27944EBF7F7815B595639735B4260134479A6AE6C65BA4BEB766BB69588FDC50783341DB81B5B0261FD2FFE658A2ED894D17D093A9835FE227FBB4CF4E355C5E404A7BE8A78A257D692081F1C8EA27F5A3D12EAEDA54D7E0BB24C258C6841925ED5FB3BBC299C62E0F781785ADC4AA4E7A948A225DC78DE1A01EC213E1F6F88A7832218DC2FBC20B195602F8B8F7A483C56B8A303180826B4B52C8C7B9FAC5719F15A1006BEC1557C4F83A1B8167F74E2FE552E2E20D5A9B44B8795AE73E7081C5F9FB8C81D52527ADB2F1E082F696E47CF8B258BCA3914369627250CB52699EE0102F402C327713BA0092AF2DE9F06A7D3AA701D6BD1CB3F777CAA2077C3658179ABD36D938D3BA82ED8C9C62C134DF21182843754704C1D3D999120378206DD599CC81D4C367AB0DFE0770DD783873F58F5DE9137A40B721FD619F66D4963E65DDA82DB6554EE73EAC7E3C66612DD55E0DF93496A9FF919F1A3DACF9D85DF3BF4699D66F5627580BCC0B81AD240A7C1EFB29C208F723EF65A2AE11EFD9AEB25FFBF90C597E4A1F5C26CE6867D2FE3659B7196695648CFBD7229A5CFCA21F866FD5F31D0130EC01BE9B5EF66E22D96685DBA3F70BF3F17973CCD157149E00660E99954ADA5A31CEA74005C7A7E9091A3AAADB0B4C9E4E5FDFE000A0C1C213C404563708FAFB1B4BDD9E9EBF9101D213144555A6C6D878996A9BCC5CFD5DFEB050A2730343F68727376838FA1A4E6000000000000000000000010233645";
        char2hex(sig_char, sig_44);
        */
        if (verb >= 3) { printf("\n signature: ");      show_array(sig_44, sig_len, 32); }
        
        unsigned int result;
        mldsa44_verify_hw(msg, sizeof(msg), pk_44, sig_44, sizeof(sig_44), ctx, sizeof(ctx), &result, interface);

        print_result_valid("MLDSA-44", result);

        free(sk_44);
		free(pk_44);
        free(sig_44);

    }

    else if (mode == 65) {
        // ---- MLDSA-65 ---- //
        if (!is_external)
	    {
	    	secmem_store_key(ID_MLDSA, &key_id_2, is_external, NULL, 0, interface);
            // secmem_store_key(ID_MLDSA, &key_id_2, true, d, 32, interface);      // Test specific Key
	    }

        unsigned char *pk_65;
		unsigned char *sk_65;
        unsigned char *sig_65;

		pk_65   = (unsigned char*) malloc(1952); memset(pk_65, 0, 1952);
		sk_65   = (unsigned char*) malloc(4032); memset(sk_65, 0, 4032);
        sig_65  = (unsigned char*) malloc(3309); memset(sig_65, 0, 3309);
        unsigned int sig_len;

		mldsa65_genkeys_hw(d, pk_65, sk_65, is_external, &key_id_2, interface);

        if (verb >= 3) {printf("\n pub_len: %d (bytes)", 1952); fflush(stdout);}
        if (verb >= 3) {printf("\n pri_len: %d (bytes)", 4032); fflush(stdout);}

        if (verb >= 3) { printf("\n public key: ");     show_array(pk_65, 1952, 32); }
        if (verb >= 3) { printf("\n private key: ");    show_array(sk_65, 4032, 32); }

        if (verb >= 3) { printf("\n msg: ");            show_array(msg, msg_len, 32); }
        if (verb >= 3) { printf("\n ctx: ");            show_array(ctx, ctx_len, 32); }

        if (verb >= 3) {printf("\n msg_len: %d (bytes)", msg_len); fflush(stdout);}
        if (verb >= 3) {printf("\n ctx_len: %d (bytes)", ctx_len); fflush(stdout);}
        
        mldsa65_sign_hw(msg, msg_len, sk_65, sig_65, &sig_len, ctx, ctx_len, is_external, &key_id_2, interface);

        if (verb >= 3) { printf("\n signature: ");      show_array(sig_65, sig_len, 32); }
        
        unsigned int result;
        mldsa65_verify_hw(msg, sizeof(msg), pk_65, sig_65, sizeof(sig_65), ctx, sizeof(ctx), &result, interface);

        print_result_valid("MLDSA-65", result);

        free(sk_65);
		free(pk_65);
        free(sig_65);

    }

    else {
        // ---- MLDSA-87 ---- //
        if (!is_external)
	    {
	    	secmem_store_key(ID_MLDSA, &key_id_3, is_external, NULL, 0, interface);
            // secmem_store_key(ID_MLDSA, &key_id_3, true, d, 32, interface);      // Test specific Key
	    }

        unsigned char *pk_87;
		unsigned char *sk_87;
        unsigned char *sig_87;

		pk_87   = (unsigned char*) malloc(2592); memset(pk_87, 0, 2592);
		sk_87   = (unsigned char*) malloc(4896); memset(sk_87, 0, 4896);
        sig_87  = (unsigned char*) malloc(4627); memset(sig_87, 0, 4627);
        unsigned int sig_len;

		mldsa87_genkeys_hw(d, pk_87, sk_87, is_external, &key_id_3, interface);

        if (verb >= 3) {printf("\n pub_len: %d (bytes)", 2592); fflush(stdout);}
        if (verb >= 3) {printf("\n pri_len: %d (bytes)", 4896); fflush(stdout);}

        if (verb >= 3) { printf("\n public key: ");     show_array(pk_87, 2592, 32); }
        if (verb >= 3) { printf("\n private key: ");    show_array(sk_87, 4896, 32); }

        if (verb >= 3) { printf("\n msg: ");            show_array(msg, msg_len, 32); }
        if (verb >= 3) { printf("\n ctx: ");            show_array(ctx, ctx_len, 32); }

        if (verb >= 3) {printf("\n msg_len: %d (bytes)", msg_len); fflush(stdout);}
        if (verb >= 3) {printf("\n ctx_len: %d (bytes)", ctx_len); fflush(stdout);}
        
        mldsa87_sign_hw(msg, msg_len, sk_87, sig_87, &sig_len, ctx, ctx_len, is_external, &key_id_3, interface);

        if (verb >= 3) { printf("\n signature: ");      show_array(sig_87, sig_len, 32); }

        unsigned int result;
        mldsa87_verify_hw(msg, sizeof(msg), pk_87, sig_87, sizeof(sig_87), ctx, sizeof(ctx), &result, interface);

        print_result_valid("MLDSA-87", result);

        free(sk_87);
		free(pk_87);
        free(sig_87);

    }

#ifdef AXI
    set_clk_frequency = FREQ_TYPICAL;
    Set_Clk_Freq(clk_index, &clk_frequency, &set_clk_frequency, (int)verb);
#endif

}